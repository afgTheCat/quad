use core::f64;

use nalgebra::{DMatrix, DVector, RawStorage, SVD};

#[derive(Debug)]
struct RidgeRegressionSol {
    coeff: DMatrix<f64>,
    intercept: DVector<f64>,
}

// Super basic ridge regression model using svd
#[derive(Debug)]
pub struct RidgeRegression {
    alpha: f64,
    sol: Option<RidgeRegressionSol>,
}

impl RidgeRegression {
    pub fn new(alpha: f64) -> Self {
        Self { alpha, sol: None }
    }

    pub fn fit(&mut self, X: &DMatrix<f64>, y: DVector<f64>, save: bool) -> (DVector<f64>, f64) {
        let y_mean = y.mean();
        // TODO: investigate why DVector::col_mean does not work
        let x_mean = DVector::from(X.column_iter().map(|col| col.mean()).collect::<Vec<_>>());

        let y_centered = y.map(|x| x - y_mean);
        let mut x_centered = X.clone();
        for (i, mut col) in x_centered.column_iter_mut().enumerate() {
            col.add_scalar_mut(-x_mean[i]);
        }

        let SVD {
            u,
            v_t,
            singular_values,
        } = SVD::new(x_centered, true, true);
        let d = singular_values.map(|x| x / (x.powi(2) + self.alpha));
        let coeff = v_t.unwrap().transpose()
            * d.zip_map(&(u.unwrap().transpose() * y_centered), |x, y| x * y);
        let intercept = y_mean - x_mean.dot(&coeff);

        if save {
            self.sol = Some(RidgeRegressionSol {
                coeff: DMatrix::from_rows(&[coeff.transpose()]),
                intercept: DVector::from_element(1, intercept),
            })
        }

        (coeff, intercept)
    }

    // y is a column vector containing stuff
    pub fn fit_multiple(
        &mut self,
        x: DMatrix<f64>,
        y: DMatrix<f64>,
    ) -> (DMatrix<f64>, DVector<f64>) {
        let (_, data_features) = x.data.shape();
        let (_, target_dim) = y.data.shape();
        let mut coeff_mult: DMatrix<f64> = DMatrix::zeros(target_dim.0, data_features.0);
        let mut intercept_mult: DVector<f64> = DVector::zeros(target_dim.0);

        for (i, col) in y.column_iter().enumerate() {
            let (coeff, intercept) = self.fit(&x, col.into_owned(), false);
            coeff_mult.set_row(i, &coeff.transpose());
            intercept_mult[i] = intercept;
        }
        self.sol = Some(RidgeRegressionSol {
            coeff: coeff_mult.clone(),
            intercept: intercept_mult.clone(),
        });
        (coeff_mult, intercept_mult)
    }

    // makes a prediction
    pub fn predict(&self, x: DMatrix<f64>) -> DMatrix<f64> {
        let Some(RidgeRegressionSol { coeff, intercept }) = self.sol.as_ref() else {
            panic!()
        };

        DMatrix::from_rows(
            &x.row_iter()
                .map(|data_point| {
                    DVector::from(
                        intercept
                            .iter()
                            .zip(coeff.row_iter())
                            .map(|(ic, c)| ic + data_point.dot(&c))
                            .collect::<Vec<_>>(),
                    )
                    .transpose()
                })
                .collect::<Vec<_>>(),
        )
    }
}

#[cfg(test)]
mod test {
    use super::RidgeRegression;
    use nalgebra::{DMatrix, DVector};

    #[test]
    fn test_ridge_regression() {
        let X = DMatrix::from_row_slice(
            50,
            1,
            &[
                0.12730328,
                0.53233789,
                0.45181234,
                0.71097479,
                -1.26160595,
                -0.6209797,
                1.89274222,
                0.60628866,
                -1.63909341,
                -0.37011608,
                -1.51284512,
                0.10126979,
                -0.45375238,
                -0.00238903,
                0.56284679,
                -0.24332625,
                0.51432886,
                0.86121137,
                -0.02677165,
                -1.08718159,
                -0.31726597,
                1.47868574,
                0.23785784,
                0.31735092,
                -0.27813452,
                0.49087183,
                -0.23242587,
                1.34510171,
                0.21745166,
                1.84961257,
                -0.78898902,
                0.39724133,
                -1.04537713,
                0.75376638,
                1.19070527,
                -0.98416078,
                1.39923842,
                1.13833305,
                0.9137407,
                -0.04450308,
                -0.71239066,
                -0.98027432,
                -1.61510796,
                -0.76403397,
                -0.08165156,
                0.95283061,
                -0.14521133,
                -0.32212366,
                1.3501879,
                2.15038297,
            ],
        );
        let y = DVector::from_row_slice(&[
            19.74903137,
            9.3668446,
            11.75968988,
            43.26982588,
            -30.03140669,
            9.12497941,
            24.44483117,
            50.76438457,
            -36.34657419,
            -16.33686133,
            -17.02813024,
            10.96379459,
            4.7874061,
            1.16429567,
            15.20020988,
            -8.0484263,
            -15.165179,
            32.21099958,
            8.1975785,
            -45.57396474,
            -2.63220052,
            28.60219831,
            -3.83780422,
            13.56656879,
            -7.67710673,
            -3.6572558,
            -19.25471479,
            9.09150348,
            15.87565673,
            44.61652919,
            -13.6509251,
            10.74222887,
            -48.97093631,
            -11.53028663,
            17.97421239,
            -10.61319007,
            28.21761357,
            49.80858454,
            6.00002819,
            9.92009008,
            -5.78856965,
            -19.59667709,
            -39.56573877,
            -8.97873999,
            -19.90600573,
            35.93309441,
            -11.18344021,
            -26.0876303,
            16.05478646,
            22.81954351,
        ]);

        let mut ridge_regression = RidgeRegression::new(10.);
        ridge_regression.fit(&X, y, true);
        let thing = ridge_regression.predict(X);
        println!("{}", thing);
    }

    #[test]
    fn multiple_regression_test() {
        let X = DMatrix::from_row_slice(
            50,
            10,
            &[
                0.6722721224549026,
                -0.34921913811594835,
                -0.8446924471317016,
                1.1722774270578469,
                -0.3519968223496652,
                0.843842055045005,
                1.1490631884147902,
                -0.19049578315740576,
                -0.7996871994715307,
                0.7419006788952703,
                3.4011057189806557,
                0.7435452461317569,
                -1.2768778466596493,
                -1.4141544662915098,
                0.041447402165011596,
                -0.6625811650314397,
                0.12673002941390707,
                -1.0669628403806435,
                0.5253295997343811,
                -0.3051810275934747,
                0.31735092273633597,
                -0.7889890249515489,
                2.1503829673811126,
                0.6062886568962988,
                -0.24332625188556253,
                -1.261605945319069,
                -0.026771649986440726,
                0.9137407048596775,
                0.12730328020698067,
                0.5628467852810314,
                0.23785783828501061,
                -0.9841607817725814,
                -0.27813451650877447,
                1.3992384201681904,
                -1.0871815907509188,
                1.190705272505982,
                -1.6151079632521659,
                -0.1452113325860197,
                -1.639093411201915,
                0.9528306110451948,
                -0.1217464334245328,
                0.47518769779384906,
                0.9552466924396553,
                0.01997092245414585,
                0.2572490050399525,
                -0.07236315822392445,
                0.8628168935353443,
                -1.6642564360602479,
                -0.44151223119024857,
                1.2690580976875576,
                0.5232452162507775,
                1.717175959710519,
                -0.1650355232064671,
                -0.9626608287669728,
                0.39254793773535773,
                0.7778483925521874,
                -0.7013680441849037,
                0.8624014081512591,
                0.20156945957526934,
                0.946348007431648,
                -1.9323560015091858,
                -0.018421809137576996,
                0.9506069961060607,
                -1.41124263188717,
                -1.4634777566193453,
                0.10767464455391365,
                1.2047437309657716,
                -0.5334945027167617,
                0.9399792195744116,
                -0.15579970816999872,
                -0.24150531238917375,
                0.07299114797407072,
                -0.25251758817880776,
                0.29164051076463826,
                -0.8416715368715004,
                -0.24006071463865328,
                -0.3896555250433101,
                -0.5534026175135522,
                0.7622308225590424,
                -0.5778416564893406,
                0.6790266830356967,
                -0.5672394268341736,
                0.08134367638997905,
                -0.6871472120485602,
                -0.8384801402483328,
                -0.6847900441875194,
                1.8366742207237288,
                0.7998766732572836,
                -0.0012405611429540924,
                0.4403789105928676,
                0.1106188085540423,
                0.15647674659188437,
                0.4777660895774647,
                1.0369968080399357,
                -0.11145904212515595,
                0.20425480457441636,
                -1.3189645536049885,
                -0.6779772552780428,
                -3.210430797268423,
                -0.3236790297502634,
                -0.0285337341330573,
                0.4813399523048028,
                -0.1165749870881772,
                -2.236053777261358,
                -1.8003657016978516,
                0.3080908624754918,
                0.5833276501518617,
                -0.41998581004543123,
                -0.23181317888607783,
                -0.13752826816152028,
                -1.2548603914775587,
                0.542544026931158,
                -0.2688785015946833,
                1.3613709645591259,
                0.18248209713031777,
                0.6261672937955176,
                -0.5226347611202428,
                1.3116180465656415,
                0.6350869000947228,
                1.2571257313814808,
                0.20780005335113885,
                0.8149954430712237,
                0.7219650574076287,
                0.3487505938690223,
                0.7291654706806434,
                -1.185418809153406,
                -0.3386182541020083,
                0.7659110492252689,
                -2.187115273247333,
                -0.7686270207784495,
                -1.2368377011017966,
                -0.2642474112620271,
                -0.6606324986051187,
                0.9929491259546886,
                0.13679032249522113,
                -0.9323592637202481,
                -0.6437970571220203,
                -0.15170019141369395,
                -0.882490391596822,
                0.31287871866605876,
                0.5704933453211514,
                1.3204048067975092,
                0.7588944642911625,
                -0.9738381295272108,
                -0.04520588860236072,
                0.04066528515761626,
                0.8048850955179162,
                -1.7385178655572635,
                0.4349760219816502,
                0.3650517980270081,
                -0.4031289968469349,
                0.5011676877836018,
                -0.9466364609859,
                0.35136152893488404,
                -0.5164428497021851,
                0.9199851312920041,
                0.788570479116926,
                -2.2068670954994913,
                0.7133254192320697,
                -0.8444764142538497,
                -1.0760914658121563,
                -0.4979713554723796,
                0.004613901175436712,
                -0.5351833981652417,
                0.3685950822771125,
                0.9384604688575977,
                0.8683775099508642,
                1.1790347434852069,
                1.0942750991001489,
                -1.2231117488973633,
                1.1515287731761275,
                0.44976720755395455,
                2.2386487591829325,
                0.9000849971172967,
                -0.5351465926388975,
                -1.430396701578305,
                0.8890323725239309,
                -0.45896716822932365,
                -1.9774177085108056,
                0.9425397724411325,
                -0.5795082893291696,
                0.1486981280629037,
                1.3391315836256719,
                1.762714296497166,
                -0.15956287406705108,
                1.4460230634069287,
                -1.0740807545618982,
                1.436570669708498,
                -0.16240072992892313,
                -0.0051374179562285,
                0.4004773841168456,
                -0.3848490502028002,
                1.100836264556602,
                -1.830354023073999,
                0.017982138806439393,
                -1.5509569211976624,
                0.6019355688249879,
                -0.4654414831035872,
                -0.11723949907063196,
                -1.7207954551375861,
                -0.5269892532991041,
                0.14375578038446712,
                -0.8677998149261569,
                0.8917941660323877,
                -0.764593898622952,
                0.9051715331786675,
                -1.5390641198540729,
                -1.01700202554413,
                0.40865864630465626,
                0.4006736681660438,
                0.5467579110457865,
                0.7571112741306737,
                -0.668307894421939,
                0.2614395928205015,
                -1.1466886495167958,
                -1.2085723310812708,
                0.46893464927171374,
                0.23082017281823,
                -0.407616632784632,
                0.9386034698816718,
                0.7718870234868406,
                -0.19380492240705713,
                -0.07115124422410989,
                -0.6191847305942658,
                0.40976548500449694,
                1.5666402273744786,
                1.2125948226530212,
                -0.5090008972919337,
                -0.5338435604421259,
                0.8579051809684236,
                2.0152208250443837,
                0.4531586132388156,
                0.5646542880869975,
                0.35953229551797367,
                -0.530327407582726,
                -0.33267577528589565,
                -0.511965094194221,
                1.3503059959308692,
                -0.057532387873538586,
                -0.38445768500357647,
                -0.4158113660344991,
                -0.8670155109522104,
                0.37476811336909965,
                0.9995238627794718,
                0.44951651436299817,
                0.3711592574799248,
                0.33912166991349607,
                -2.3269262116155196,
                2.5920840674002923,
                -0.16127395672832917,
                -0.08165155616424355,
                -0.31726597100271015,
                -0.002389025600514556,
                -0.2324258720274623,
                -0.37011607810475444,
                1.1383330474921514,
                0.7109747948581455,
                1.8496125662057936,
                -0.9802743185258672,
                -0.3221236569774085,
                1.5418077084686126,
                -0.644619180730499,
                1.147309002011903,
                -0.16224855290821893,
                0.20581615250656984,
                -1.1702444249284003,
                -1.0747468405930436,
                -0.404357671797137,
                0.8001528559058803,
                -1.0259108732843625,
                0.12677274472597902,
                -0.911344781357355,
                0.31717096074155054,
                -1.81842142065901,
                -0.41395371382728313,
                -0.7461352526666984,
                0.05569219339294779,
                -0.2918113875232261,
                -1.247336156644393,
                -0.7709685285300425,
                0.7387144235342626,
                -0.19422133384463808,
                0.23254262542334578,
                0.5319765561553507,
                -0.6861465851073458,
                0.5877885293013254,
                -1.3703642428009506,
                -0.06434314961587694,
                -1.3825474846365924,
                -0.7068190812919728,
                -0.6575172676978901,
                -1.9453906815188249,
                -0.6510564789536804,
                -1.1205068713840005,
                0.5011372949374676,
                0.8309056578021413,
                -0.3466067875476209,
                1.3303169236725105,
                0.18494595039221876,
                1.749241790081012,
                1.3043577797963937,
                0.6085923102841594,
                0.8224723016354284,
                1.4267264504853654,
                1.0461644964376338,
                -1.393525225748726,
                -0.048697610640109204,
                -2.4957528823141972,
                0.6609032917196628,
                0.6586660668217251,
                2.386745800499031,
                0.36003178759974036,
                -0.6862364377992013,
                0.1549035962020594,
                -0.6753750576188053,
                -0.43820143730669325,
                0.277836156413196,
                -0.4192603220087837,
                -0.5083432327925071,
                0.2283352044566521,
                0.1997790971313106,
                -0.8732591793851744,
                -0.2648908941443411,
                -0.5361687068333683,
                -1.0319348271510602,
                0.5560180812944249,
                -2.6939563172399312,
                -0.6359031894503993,
                -0.19651664300377936,
                0.2673819755787573,
                1.075681534164297,
                0.7547050088790299,
                -0.5108262341824535,
                -0.025645745936127125,
                -0.9776990052219913,
                -0.7598847788231394,
                -0.9590398006025731,
                0.747371595544824,
                -0.7574771053093196,
                -1.054657177172913,
                0.4553185270261121,
                0.1687210624313978,
                -0.565046518309226,
                0.7061888116045446,
                -0.11032172211623395,
                -1.4889501692875957,
                0.005043898069076927,
                -0.7046047621786199,
                -1.220671903715444,
                -1.8552666603782968,
                -0.49429864739786794,
                0.080866188394344,
                0.29202648981800744,
                0.15420459268584072,
                1.0898461110532707,
                -2.319847554388968,
                0.8173055190310792,
                0.45053117920927527,
                -0.5465767417188724,
                -0.34112117132031883,
                -0.04995254339686802,
                -0.33240947257420594,
                -0.059260833836361,
                -0.9041049314828216,
                -1.812024553173441,
                2.0921686012929617,
                0.7027533792191322,
                0.9962094669993536,
                -1.0670398044692198,
                0.44080738731842145,
                0.5143288551447859,
                0.49087183250951594,
                -1.5128451152607716,
                -0.7640339696578627,
                -0.4537523812416193,
                1.8927422187767202,
                0.1012697856437548,
                0.21745165945019368,
                0.3972413264075336,
                -0.6209797023155086,
                0.4446977161029871,
                -0.1522965744944709,
                0.9407870683897978,
                0.41730231988738953,
                0.23966318182680454,
                0.704626894626221,
                0.26955855330903167,
                -1.5120214739877849,
                0.2532205247585785,
                0.6129550677145995,
                -1.391766084294036,
                -0.030667987475674858,
                1.2795087343766578,
                0.8672126651998152,
                -0.8912937922772961,
                -0.8814625655313383,
                -0.5209590207114089,
                0.7909698216528814,
                0.3303022703226134,
                0.3532107803002698,
                -0.36184796336959735,
                -0.8135337616981977,
                -1.4615058094923734,
                0.35021313455542263,
                -1.9278777352364316,
                -0.935955221598663,
                0.47347563519013397,
                -0.08809626952746996,
                1.1950253748410917,
                0.9630313786660784,
                -1.0790126956031663,
                -0.17830606215500272,
                -0.22467908543381457,
                -0.5136792046662925,
                0.5751509658063075,
                -1.5232135953524801,
                -1.257253734973249,
                -0.10321862725194576,
                0.6558615323233493,
                -0.7320583853311774,
                -1.5340965702283584,
                0.1406138453747909,
                0.117052488790469,
                -0.557684623006479,
                2.4897075316883863,
                0.019892207578106016,
                -0.9570655488171265,
                1.0525318150652148,
                0.015174920002897885,
                0.6793203874098627,
                0.9223441482568703,
                -0.5231642148972904,
                -0.37591996120915105,
                0.6398839732802036,
                -0.757453225587536,
                -0.48137141579474935,
                2.0536932362953815,
                0.45348104026746144,
                -0.20734969827652708,
                -1.9241594490929896,
                -0.0001493927548569246,
                0.11163027156564224,
                -0.913446285204153,
                -1.0526677980507988,
                -0.1463693097462854,
                0.2829905076675621,
                -0.5586105579100125,
                -1.0835914658230943,
                -1.1527257504517598,
                -1.469634625209567,
                0.46565797200403236,
                -0.928335225810039,
                0.5622617060581323,
                -0.3148580761325759,
                0.5479183096073379,
                -0.7746600331288077,
                -0.42989708186880404,
                -0.8541429534648363,
                -0.7209996734353815,
                -0.4371456556814915,
                0.5323378882945463,
                -0.712390662050588,
                0.8612113741693206,
                1.4786857374358966,
                0.45181233874578974,
                0.753766378659703,
                -1.0453771305385342,
                1.3451017084510097,
                1.3501878997225267,
                -0.044503078338053455,
                0.15003366373872756,
                0.5022857779517222,
                1.982925182595953,
                0.2676098967321498,
                -0.308375994286531,
                0.839193535320577,
                0.8784598910238555,
                -0.28410380510716565,
                -1.0942595125916925,
                -1.055658897711565,
                0.7958769911591804,
                -0.19163168438548278,
                0.14202678794857176,
                0.7420478267454842,
                0.4609946505605043,
                0.4838288394495532,
                1.1114411280385852,
                -0.5956856051072797,
                -2.233052848438117,
                1.2751258373944747,
                0.2754714469462586,
                -1.6003841181528236,
                -0.9824603525381572,
                0.017446916303085782,
                1.2567430683363894,
                -0.22205672759554324,
                -0.7200583582807348,
                -1.6495595298995447,
                0.7085245177855963,
                1.2750575903893269,
            ],
        );

        let y = DMatrix::from_row_slice(
            50,
            3,
            &[
                -12.387682000862526,
                -45.68768962328415,
                -11.66281769741045,
                -35.980852683992005,
                14.579499502760193,
                51.17692816389498,
                13.586613316561749,
                -3.598725388609366,
                -39.62563362982551,
                -26.47418230580775,
                -13.689809148559196,
                -102.41941685588677,
                -21.2893162732212,
                27.817797118305158,
                78.28631071884037,
                36.531796399083305,
                30.104396822918112,
                151.15953878481776,
                24.242641380613737,
                -19.50279497037695,
                -8.86258444251012,
                35.08020277846573,
                3.214848107123589,
                3.3394270745352435,
                11.841790853484753,
                -11.7891541210465,
                -20.64526145260464,
                36.77908902501921,
                13.728653907892674,
                36.27931933998782,
                11.799356791950245,
                -2.301532763337277,
                18.504143002984392,
                10.444269449635739,
                -7.990157436680888,
                32.39984999461106,
                18.43926722859875,
                21.32969255922366,
                40.026020314102524,
                -7.720953733674717,
                18.80035973796894,
                -46.27320422527903,
                45.97302887967786,
                28.824409891982356,
                117.93745809511705,
                7.581485454237754,
                17.694289800146098,
                61.846650857449966,
                -54.583552340460635,
                -6.747416199005681,
                -47.08886556193768,
                14.829252481947032,
                -34.457678164672146,
                34.93940177468792,
                -23.136168458879897,
                -13.544680234294228,
                7.598620812671153,
                0.16398686368063053,
                18.703220161149066,
                -40.208497985385144,
                5.0401736436323485,
                -12.634452565376707,
                40.51302072907759,
                24.511050132358484,
                42.849959244484175,
                84.8839187406526,
                -13.022783935345277,
                28.133376000680293,
                -62.09316711737081,
                -20.82057012790299,
                3.4201937517718317,
                32.197623653747286,
                20.267842960168675,
                16.936808536369135,
                -89.73591868211085,
                21.93681848915575,
                9.631316188631475,
                -20.518734314557186,
                -29.70854216041036,
                -4.1049773433966354,
                -59.71009897604023,
                -35.391851086547966,
                -14.532033788989576,
                -54.73271065205187,
                -26.011826289864207,
                2.228706551583125,
                -31.350245579824424,
                -42.96698646713793,
                -34.21588619769808,
                -191.7542282463115,
                37.01996155156358,
                -0.6083027188924541,
                37.922174791209635,
                -24.605766883150537,
                -14.732144162786831,
                40.73925774442725,
                -34.45422472471462,
                -27.42467932938338,
                -66.46874947861957,
                15.507624541014843,
                47.649249279273114,
                60.63494631967404,
                3.4672004501849596,
                -1.1510785177943599,
                32.438476892854894,
                14.012515808311264,
                14.510797451078707,
                24.13815917006147,
                4.759476206896743,
                -29.439660241428054,
                8.163640192151277,
                -0.7788286455214468,
                -32.42213670511347,
                43.65472440855334,
                3.8136282422546257,
                3.9993795383832333,
                8.151768731871375,
                1.3039045877100732,
                1.9098646704286657,
                -37.37674750261218,
                -40.409169779823735,
                4.72383747797924,
                -89.29120971383801,
                4.205207987989803,
                10.975002988386242,
                -7.766001429717928,
                17.986467730870324,
                8.058378608572934,
                21.938015360785716,
                -31.47582674114986,
                -21.90295214417289,
                -32.03150503272249,
                3.3081021991630664,
                8.29852165491064,
                -4.779843324916861,
                -48.88699627827232,
                -9.317180651402708,
                -97.66096276501956,
                -22.76464251487964,
                -13.323112194544054,
                -91.47430785572033,
                -5.939232938555492,
                -36.58280304175286,
                3.483501298485436,
                -6.863540152319516,
                8.661535634763665,
                -2.829823130387629,
                -35.288845650179205,
                16.919715076745845,
                -178.64549209663224,
            ],
        );

        let mut rr = RidgeRegression::new(10.);
        let (coeff, intercept) = rr.fit_multiple(X.clone(), y);
        println!("coeff: {coeff} {intercept}");
        println!("{}", rr.predict(X));
    }
}
